#!/bin/bash

echo "================================================"
echo "   ðŸš€ Ð›ÐÐ“ÐšÐ˜Ð™ Ð—ÐÐŸÐ£Ð¡Ðš Ð“Ð•ÐÐ•Ð ÐÐ¢ÐžÐ Ð"
echo "   (Ð±ÐµÐ· Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ð½Ðµ Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ)"
echo "================================================"
echo ""

echo "ðŸ“ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ð°Ð¿ÐºÐ°: $(pwd)"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python
echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Python..."
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
    echo ""
    echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Python:"
    echo "   MacOS: brew install python"
    echo "   Linux: sudo apt install python3"
    echo ""
    exit 1
fi
echo "âœ… Python ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
if [ ! -d "virtual/.venv" ]; then
    echo "âš   Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
    echo "ðŸ“¥ Ð¡Ð¾Ð·Ð´Ð°ÑŽ..."
    cd virtual
    uv venv .venv
    cd ..
else
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi
echo ""

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
echo "ðŸ“¥ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
cd virtual
source .venv/bin/activate

if ! python3 -c "import fastapi" &> /dev/null; then
    echo "âš   Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
    uv pip install fastapi uvicorn requests pydantic --quiet
    echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
else
    echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
fi
cd ..
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ollama
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ollama..."
if ! command -v ollama &> /dev/null; then
    echo "âš   Ollama Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo ""
    echo "ðŸ“¥ Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½ÑƒÐ¶ÐµÐ½ Ollama"
    echo "ðŸ’¡ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: curl -fsSL https://ollama.com/install.sh | sh"
    echo ""
    exit 1
else
    echo "âœ… Ollama Ð½Ð°Ð¹Ð´ÐµÐ½"
fi
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ollama
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¸ Ollama..."
if ! curl -s http://localhost:11434/api/tags &> /dev/null; then
    echo "âš   Ollama Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
    echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð² Ñ„Ð¾Ð½Ðµ..."
    ollama serve &
    OLLAMA_PID=$!
    echo "â³ Ð–Ð´Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÐ° (5 ÑÐµÐº)..."
    sleep 5
else
    echo "âœ… Ollama ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
fi
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ..."
if ! ollama list | grep -q "qwen2.5:7b"; then
    echo "âš   Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐœÐ¾Ð´ÐµÐ»ÑŒ Qwen2.5:7b Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!"
    echo ""
    echo "ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑ€ Ð¼Ð¾Ð´ÐµÐ»Ð¸: 4.6 Ð“Ð‘"
    echo "â³ Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: 5-20 Ð¼Ð¸Ð½ÑƒÑ‚"
    echo ""
    echo "â“ Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ ÑÐµÐ¹Ñ‡Ð°Ñ?"
    echo "   1) Ð”Ð°, Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)"
    echo "   2) ÐÐµÑ‚, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð±ÐµÐ· Ð¼Ð¾Ð´ÐµÐ»Ð¸"
    echo "   3) Ð’Ñ‹Ñ…Ð¾Ð´"
    echo ""
    
    read -p "Ð’Ð°Ñˆ Ð²Ñ‹Ð±Ð¾Ñ€ (1/2/3): " choice
    
    case $choice in
        1)
            echo "â¬‡ï¸  Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ..."
            echo "â³ Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ..."
            ollama pull qwen2.5:7b
            echo "âœ… ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°!"
            ;;
        2)
            echo "âš   ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽ Ð±ÐµÐ· Ð¼Ð¾Ð´ÐµÐ»Ð¸..."
            echo "ðŸ’¡ ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ: ollama pull qwen2.5:7b"
            ;;
        3)
            echo "ðŸ›‘ Ð’Ñ‹Ñ…Ð¾Ð´..."
            exit 0
            ;;
        *)
            echo "âš   ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽ Ð±ÐµÐ· Ð¼Ð¾Ð´ÐµÐ»Ð¸..."
            ;;
    esac
else
    echo "âœ… ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
fi
echo ""

echo "================================================"
echo "                ðŸŽ‰ Ð’Ð¡Ð Ð“ÐžÐ¢ÐžÐ’Ðž!"
echo "================================================"
echo ""
echo "ðŸŒ API ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð½Ð°:"
echo "ðŸ“ http://localhost:3001"
echo ""
echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:"
echo "ðŸ“ http://localhost:3001/docs"
echo ""
echo "ðŸ›‘ Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"
echo "================================================"
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
virtual/.venv/bin/python server.py

# Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ollama Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ
if [ ! -z "$OLLAMA_PID" ]; then
    kill $OLLAMA_PID 2>/dev/null
fi